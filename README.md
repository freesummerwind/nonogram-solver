# Семестровое домашнее задание по АИСД
## Тема: Программа для решения японских кроссвордов (нонограмм)
Выполнила: Бояркина Елизавета, студент группы ИУ8-51

![CI](https://github.com/freesummerwind/nonogram-solver/workflows/CI/badge.svg?branch=dynamic_programming)

## Теоретическая часть
Японский кроссворд — головоломка, в которой с помощью цифр зашифровано некоторое изображение. Целью головоломки является 
полное восстановление этого изображения.

Японские кроссворды бывают двух видов — черно-белые и цветные. В черно-белых кроссвордах изображение содержит только 
два цвета — черный (которым картинка и заполняется) и белый (фоновый). В цветных кроссвордах изображение создается 
несколькими цветами на белом фоне.

Числа, указанные слева и сверху у кроссворда — описывают группы закрашенных клеток (идущих подряд, без пропусков) по 
горизонтали и вертикали соответственно. Порядок этих чисел описывает порядок расположения этих групп, но где 
каждая группа начинается и заканчивается — не известно (таким образом, определить их положение и является задачей 
головоломки). Каждое число обозначает отдельную группу заданного размера (т.е. число 3 - обозначает группу из 
трех закрашенных подряд клеток, 1 - группу из одной единственной закрашенной клетки). В черно-белых кроссвордах клетка 
всегда закрашивается черным цветом, в цветных — клетка закрашивается тем цветом, которым помечено число. Между 
группами одного цвета должна быть как минимум одна не закрашенная клетка, между группами разных цветов пустых клеток 
может не быть.

Главным требованием к японским кроссвордам является то, что кроссворд должен иметь единственное логическое решение, 
достижимое без "угадываний" (метода проб и ошибок).

Пример черно-белого кроссворда:

![alt text](pictures/black_and_white.png "Пример черно-белого кроссворда")

Пример цветного кроссворда:

![alt text](pictures/colored.png "Пример цветного кроссворда")

## Формальная постановка задачи
Написать программу, которая будет правильно решать поданную ей на вход корректно составленную нонограмму. Корректной 
считается нонограмма, имеющая единственное решение, которое можно получить логическими рассуждениями. В случае, если 
поданная на вход нонограмма не может быть решена, программа должна выдавать сообщение об этом и подавать на выход 
частично решенную нонограмму. При некорректном вводе должно выводиться сообщение об ошибке.

## Форматы входных и выходных данных
На вход программе первым аргументом командной строки подается адрес текстового файла, содержащего описание нонограммы.
Файл должен содержать в себе следующие поля: colors, lines, columns. Поле colors содержит в себе список идентификаторов
цветов, использованных для описания нонограммы (для одноцветной нонограммы нужно указать тот единственный идентификатор,
который будет использован для всех ячеек нонограммы). Идентификаторы вводятся через пробел. Поле lines содержит в себе 
последовательность массивов. Каждый массив содержит в себе описание соответствующей строки: первый массив описывает 
первую строку, второй — вторую и т.д. Каждый массив, описывающий новую строку, записывается с новой строки. Массив 
содержит в себе последовательность слов вида '5r', где 'r' - цвет группы, 5 - ее длина. Поле columns заполняется 
аналогично полю lines, только для столбцов. При этом матрица столбцов транспонируется — первая строка соответствует 
транспонированному первому столбцу, вторая — второму и т.д.
  
Пример корректного входного файла для цветной нонограммы:

```
colors: r b
lines:
2b 1r 1b
1b 1r

2b
3r
columns:
2b 1r
1b 1b 1r
2r 1b 1r
1b 1b
```

Программа выводит текстовый файл с решенным кроссвордом либо сообщение об ошибке. Если файл с решением нужно сохранить, 
то программе на вход нужно подать путь к файлу, в котором нужно сохранить картинку, аргументом -s командной строки. 
Пример корректного ввода:

```
./nonogram-solver input.txt
./nonogram-solver input.txt -s output.txt
```

## Известные алгоритмы решения
### 1. Полный перебор
Для каждой клеточки перебираются все возможные варианты окраски, каждый полученный набор клеток проверяется на 
соответствие исходным условиям. Сложность такого алгоритма в общем виде для K цветов: O(N * M * K ^ (N * M)), где 
N, M - количество строк и столбцов, соответственно.
### 2. Backtracking
Перебираются решения не для каждой клетки поотдельности, а для каждой горизонтальной группы клеток. Группы клеток 
переставляются в каждой строке, после чего каждый набор перестановок проверяется на соответствие исходным условиям.
Сложность такого алгоритма O(П(X_i) для i = 1...N), где X_i - число способов расставить горизонтальные группы в i-ой 
строке. Таким образом, если в худшем случае число перестановок для группы в строке - A, которое некоторым образом 
зависит от количества столбцов, количества горизонтальных групп в строке и их длины, то сложность алгоритма - O(A ^ N).
### 3. Решение поочередно для каждого ряда
Каждый ряд и столбец анализируются поотдельности, после анализа для некоторых клеток устанавливается окончательное 
состояние, для некоторых - уменьшается количество цветов, в которые эту клетку можно окрасить. После этого строка 
и столбец, содержащие измененную клетку, перерассчитываются, так как изменение для этой клетки может повлечь изменение 
состояний остальных клеток. Сразу строку или столбец раскрыть нельзя, но изменения помогают раскрыть информацию для 
других клеток, и через несколько итераций для каждой клетки остается только один возможный цвет.
Сложность алгоритма в худшем случае O(N * M * Z) - в худшем случае одна итерация раскрывает информацию только об одной клетке,
Z - сложность алгоритма анализа строки.

Алгоритм анализа строки - пытаемся расставить группы строк так, чтобы они не нарушали уже заполненные клетки. Для этого 
пытаемся поставить первую группу с первой клетки, вторую - с (len_1 + 1) и т.д. Если расстановка нарушает уже известные
клетки - переходим на блок выше и ставим его в следующую клетку. Затем для каждой клетки анализируем все возможные 
варианты заполнения, сопоставляем с возможными до этого вариантами. Если для клетки остался только один возможный цвет - 
окрашиваем ее в него. Алгоритм рекурсивный, для уменьшения числа вызовов - храним в памяти возможность поставить i-й блок
начиная с j-й клетки (для каждого перерасчета для строки эта матрица заполняется заново). Тогда сложность алгоритма - 
сложность заполнения матрицы (A * B), где A - число блоков, B - число клеток (N или M, соответственно). Заметим, что при 
B = M получаем A <= N, а при B = N, A <= M. Тогда сложность расчета O(N * M), и итоговая сложность алгоритма - O(N * M).

При выполнении задания был реализован третий алгоритм.

## План решения
Язык реализации - Python

Идея алгоритма: поочередно проходим строки и столбцы и заполняем матрицу решения в соответствии с имеющейся информацией.
При заполнении какой-либо клетки - добавляем строку и столбец, на пересечении которых она лежит, в очередь. Алгоритм 
завершается, когда заканчивается очередь строк и столбцов, которые нужно проверить. Если при этом заполнена не вся 
матрица решения, то это значит, что нонограмма составлена некорректно и решить ее без метода проб и ошибок невозможно.

Примерная структура программы:
- функция-обработчик входного файла;
- функция, заполняющая строку (столбец) в соответствии с имеющейся информацией;
- функция, непосредственно решающая нонограмму. Она вызывает функцию заполнения поочередно для строк и столбцов и 
  обновляет очередь из строк и столбцов, пока не будет заполнена вся матрица решений (или пока можно будет получить 
  новую информацию о решении);
- функция, представляющая полученное решение в виде выходного файла.

## Логика работы программы
Программа считывает данные из исходного файла, после чего обрабатывает их для приведения в удобный для вычислений формат.
Производится простая проверка нонограммы на корректность (нет неопознанных цветов, количество клеток каждого цвета в информации
о строках и столбцах совпадает). После этого в соответствии с описанным выше алгоритмом (под номером три - линии поочередно
анализируются) производится расчет нонограммы. Если какая-либо клетка не может быть закрашена ни одним цветом (из-за некорректного
условия) - подается сообщение об ошибке. Если условие корректно, то на выход подается решенная нонограмма.

Подробное описание работы алгоритмов и использованных структур данных приведено в комментариях в исходном коде.

## Инструкция по компиляции
Python - скриптовый язык, поэтому код можно запускать без компиляции в интерпретаторе python. Если такой возможности нет,
то можно выбрать архив для нужной ОС из релиза или скомпилировать самостоятельно при помощи библиотеки pyinstaller:
```
pyinstaller nonogram-solver nonogram_solver.py
```
